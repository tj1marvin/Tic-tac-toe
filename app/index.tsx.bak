import React, { useState } from 'react';
import {
  Modal,
  SafeAreaView,
  StyleSheet,
  Text,
  TextInput,
  TouchableOpacity,
  View,
} from 'react-native';

type Player = 'X' | 'O' | null;
type Board = Player[];

interface PlayerNames {
  X: string;
  O: string;
}

interface GameSettings {
  backgroundColor: string;
  playerNames: PlayerNames;
}

interface SquareProps {
  value: Player;
  onPress: () => void;
  backgroundColor: string;
}

const Square = ({ value, onPress, backgroundColor }: SquareProps) => (
  <TouchableOpacity 
    style={[styles.square, { backgroundColor }]} 
    onPress={onPress}
  >
    <Text style={styles.squareText}>{value}</Text>
  </TouchableOpacity>
);

function TicTacToe() {
  const [board, setBoard] = useState(Array(9).fill(null) as Board);
  const [xIsNext, setXIsNext] = useState(true);
  const [settings, setSettings] = useState({
    backgroundColor: '#f0f0f0',
    playerNames: { X: 'Player X', O: 'Player O' }
  });
  const [isSettingsVisible, setIsSettingsVisible] = useState(false);

  const calculateWinner = (squares: Board): Player => {
    const lines = [
      [0, 1, 2], [3, 4, 5], [6, 7, 8], // Rows
      [0, 3, 6], [1, 4, 7], [2, 5, 8], // Columns
      [0, 4, 8], [2, 4, 6] // Diagonals
    ];

    for (let i = 0; i < lines.length; i++) {
      const [a, b, c] = lines[i];
      if (squares[a] && squares[a] === squares[b] && squares[a] === squares[c]) {
        return squares[a];
      }
    }
    return null;
  };

  const handlePress = (index: number): void => {
    if (board[index] || calculateWinner(board)) return;

    const newBoard = board.slice();
    newBoard[index] = xIsNext ? 'X' : 'O';
    setBoard(newBoard);
    setXIsNext(!xIsNext);
  };

  const resetGame = (): void => {
    setBoard(Array(9).fill(null));
    setXIsNext(true);
  };

  const updateSettings = (newSettings: Partial<GameSettings>) => {
    setSettings({ ...settings, ...newSettings });
  };

  const renderSquare = (index: number) => (
    <Square
      value={board[index]}
      onPress={() => handlePress(index)}
      backgroundColor={settings.backgroundColor}
    />
  );

  const winner = calculateWinner(board);
  const status = winner
    ? `Winner: ${settings.playerNames[winner]}`
    : board.every((square: Player) => square)
    ? 'Game Draw!'
    : `Next player: ${settings.playerNames[xIsNext ? 'X' : 'O']}`;

  return (
    <SafeAreaView style={styles.safeArea}>
      <View style={styles.container}>
        <Text style={styles.title}>Tic Tac Toe</Text>
        <Text style={styles.status}>{status}</Text>
        <View style={styles.board}>
          <View style={styles.row}>
            {renderSquare(0)}
            {renderSquare(1)}
            {renderSquare(2)}
          </View>
          <View style={styles.row}>
            {renderSquare(3)}
            {renderSquare(4)}
            {renderSquare(5)}
          </View>
          <View style={styles.row}>
            {renderSquare(6)}
            {renderSquare(7)}
            {renderSquare(8)}
          </View>
        </View>
        <View style={styles.buttonContainer}>
          <TouchableOpacity 
            style={styles.button} 
            onPress={() => setIsSettingsVisible(true)}
          >
            <Text style={styles.buttonText}>Settings</Text>
          </TouchableOpacity>
          <TouchableOpacity 
            style={styles.button} 
            onPress={resetGame}
          >
            <Text style={styles.buttonText}>Reset Game</Text>
          </TouchableOpacity>
        </View>
        
        <Modal
          animationType="slide"
          transparent={true}
          visible={isSettingsVisible}
          onRequestClose={() => setIsSettingsVisible(false)}
        >
          <View style={styles.modalContainer}>
            <View style={styles.modalContent}>
              <Text style={styles.modalTitle}>Game Settings</Text>
              
              <Text style={styles.label}>Player X Name:</Text>
              <TextInput
                style={styles.input}
                value={settings.playerNames.X}
                onChangeText={(text: string) => 
                  updateSettings({ 
                    playerNames: { ...settings.playerNames, X: text } 
                  })
                }
              />
              
              <Text style={styles.label}>Player O Name:</Text>
              <TextInput
                style={styles.input}
                value={settings.playerNames.O}
                onChangeText={(text: string) => 
                  updateSettings({ 
                    playerNames: { ...settings.playerNames, O: text } 
                  })
                }
              />

              <Text style={styles.label}>Board Color:</Text>
              <View style={styles.colorContainer}>
                {['#f0f0f0', '#FFE4E1', '#E0FFFF', '#98FB98', '#DDA0DD'].map((color) => (
                  <TouchableOpacity
                    key={color}
                    style={[styles.colorOption, { backgroundColor: color }]}
                    onPress={() => updateSettings({ backgroundColor: color })}
                  />
                ))}
              </View>

              <TouchableOpacity 
                style={styles.button}
                onPress={() => setIsSettingsVisible(false)}
              >
                <Text style={styles.buttonText}>Close</Text>
              </TouchableOpacity>
            </View>
          </View>
        </Modal>
      </View>
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  safeArea: {
    flex: 1,
    backgroundColor: '#fff',
  },
  container: {
    flex: 1,
    alignItems: 'center',
    justifyContent: 'center',
  },
  title: {
    fontSize: 24,
    fontWeight: 'bold',
    marginBottom: 20,
  },
  status: {
    marginBottom: 20,
    fontSize: 18,
    fontWeight: '600',
  },
  board: {
    marginBottom: 20,
  },
  row: {
    flexDirection: 'row',
  },
  square: {
    width: 80,
    height: 80,
    borderWidth: 1,
    borderColor: '#999',
    alignItems: 'center',
    justifyContent: 'center',
  },
  squareText: {
    fontSize: 40,
    fontWeight: 'bold',
  },
  buttonContainer: {
    flexDirection: 'row',
    justifyContent: 'space-around',
    width: '80%',
    marginTop: 20,
  },
  button: {
    backgroundColor: '#4CAF50',
    padding: 10,
    borderRadius: 5,
    minWidth: 100,
    alignItems: 'center',
    marginHorizontal: 10,
  },
  buttonText: {
    color: '#fff',
    fontSize: 16,
    fontWeight: 'bold',
  },
  modalContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: 'rgba(0, 0, 0, 0.5)',
  },
  modalContent: {
    backgroundColor: '#fff',
    padding: 20,
    borderRadius: 10,
    width: '80%',
    maxWidth: 400,
  },
  modalTitle: {
    fontSize: 20,
    fontWeight: 'bold',
    marginBottom: 20,
    textAlign: 'center',
  },
  label: {
    fontSize: 16,
    marginBottom: 5,
  },
  input: {
    borderWidth: 1,
    borderColor: '#ddd',
    borderRadius: 5,
    padding: 8,
    marginBottom: 15,
  },
  colorContainer: {
    flexDirection: 'row',
    justifyContent: 'space-around',
    marginBottom: 20,
  },
  colorOption: {
    width: 40,
    height: 40,
    borderRadius: 20,
    borderWidth: 1,
    borderColor: '#999',
  },
});

export default TicTacToe;